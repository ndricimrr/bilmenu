<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=UA-126905227-1"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "UA-126905227-1");

      // Track app source for different platforms
      const urlParams = new URLSearchParams(window.location.search);
      const source = urlParams.get("source") || "web-browser";

      gtag("event", "app_source", {
        event_category: "source",
        event_label: source,
      });
    </script>
    <meta
      charset="UTF-8"
      content="Bilkent University, Bilkent, ‚îú¬£niversite, kafeterya, yemek, b‚îú‚ïùfe, Ankara, Turkey, T‚îú‚ïùrkiye, beslenme, tabldot, monu, food, sa‚îÄ∆íl‚îÄ‚ñíkl‚îÄ‚ñí, saglikli, yiyecek"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BilMenu - Bilkent University Cafeteria Menu</title>

    <link rel="icon" type="image/x-icon" href="images/logo.ico" />

    <link rel="stylesheet" href="css/header.css" />
    <link rel="stylesheet" href="css/index.css" />
    <link rel="stylesheet" href="css/language-switcher.css" />
    <link rel="stylesheet" href="css/mobile-app.css" />
    <script src="js/burger.js"></script>
    <script src="js/utilities.js"></script>

    <script src="js/constants.js"></script>
    <script src="js/meal.js"></script>
    <script src="js/day.js"></script>
    <script src="js/week.js"></script>

    <script src="js/fetchMealPlan.js"></script>

    <!-- Translation System -->
    <script src="js/translations.js"></script>
    <script src="js/language-switcher.js"></script>

    <!-- Mobile App Integration -->
    <script src="js/mobile-app.js"></script>
  </head>
  <body>
    <!-- Modal -->
    <div class="modal" id="modal">
      <div class="modal-content" id="modalContent">
        <button class="close-button" onclick="closeModal()">X</button>
        <img
          id="modalImage"
          src="https://dummyimage.com/600x400"
          alt="Meal Image"
        />
        <h2 id="modalNameTr">Yemek</h2>
        <p id="modalNameEn">Food</p>
        <button
          id="contribute-btn"
          onclick="goToContributions()"
          data-translate="modal.contribute"
        >
          Contribute Now
        </button>
      </div>
    </div>

    <!-- Header -->
    <header class="site-header">
      <div class="nav-container">
        <div class="page-title" onclick="goHome()" title="Go Home">
          <img
            class="home-logo"
            src="assets/images/logos/logo_m.png"
            alt="Logo"
          />
          <div class="title-text">
            BilMenu
            <span style="font-size: small">Bilkent University Cafeteria</span>
          </div>
        </div>

        <nav class="main-nav">
          <ul class="nav-list">
            <li>
              <a href="#" onclick="refreshPage(); return false;"
                ><b style="color: blue"> &#8635;</b>
                <u data-translate="nav.refresh">Refresh</u></a
              >
            </li>

            <li>
              <a
                href="https://github.com/ndricimrr/bilmenu"
                class="github-logo"
                target="_blank"
                rel="noopener noreferrer"
              >
                <span data-translate="nav.github">Github Project</span>
                <img src="images/github-mark.png" alt="GitHub Logo" />
              </a>
            </li>
            <li>
              <a href="contributions.html" data-translate="nav.contributions"
                >Contributions</a
              >
            </li>
            <li>
              <a href="privacy-policy.html" data-translate="nav.privacy"
                >Privacy Policy</a
              >
            </li>
            <li>
              <a href="about-us.html" data-translate="nav.about">About</a>
            </li>
          </ul>
          <button class="mobile-menu-toggle">
            <span></span>
            <span></span>
            <span></span>
          </button>
        </nav>
      </div>
    </header>
    <!-- Page Container -->
    <div class="container">
      <!-- Hero Section -->
      <div class="hero-section">
        <h1 class="hero-title" data-translate="hero.title">BilMenu</h1>
        <h2 class="hero-subtitle" data-translate="hero.subtitle">
          Bilkent University Cafeteria Menu
        </h2>
        <p class="hero-description" data-translate="hero.description">
          Discover today's mealplan
        </p>
      </div>

      <!-- Week Indicator -->
      <div class="week-indicator" id="weekIndicator">
        <span class="week-text" id="weekText" data-translate="week.prefix"
          >Week 4 - 20.01.25 - 26.01.25</span
        >
      </div>

      <!-- Day Selection -->
      <div class="days-list" id="daysList">
        <div class="day-column">
          <div class="today-label" data-translate="day.today">Today</div>
          <button onclick="showMenu(DaysOfWeek.Monday)" data-day="0">
            <span class="day-full" data-translate="day.monday">Monday</span>
            <span class="day-short" data-translate="day.monday.short">Mon</span>
          </button>
        </div>
        <div class="day-column">
          <div class="today-label" data-translate="day.today">Today</div>
          <button onclick="showMenu(DaysOfWeek.Tuesday)" data-day="1">
            <span class="day-full" data-translate="day.tuesday">Tuesday</span>
            <span class="day-short" data-translate="day.tuesday.short"
              >Tue</span
            >
          </button>
        </div>
        <div class="day-column">
          <div class="today-label" data-translate="day.today">Today</div>
          <button onclick="showMenu(DaysOfWeek.Wednesday)" data-day="2">
            <span class="day-full" data-translate="day.wednesday"
              >Wednesday</span
            >
            <span class="day-short" data-translate="day.wednesday.short"
              >Wed</span
            >
          </button>
        </div>
        <div class="day-column">
          <div class="today-label" data-translate="day.today">Today</div>
          <button onclick="showMenu(DaysOfWeek.Thursday)" data-day="3">
            <span class="day-full" data-translate="day.thursday">Thursday</span>
            <span class="day-short" data-translate="day.thursday.short"
              >Thu</span
            >
          </button>
        </div>
        <div class="day-column">
          <div class="today-label" data-translate="day.today">Today</div>
          <button onclick="showMenu(DaysOfWeek.Friday)" data-day="4">
            <span class="day-full" data-translate="day.friday">Friday</span>
            <span class="day-short" data-translate="day.friday.short">Fri</span>
          </button>
        </div>
        <div class="day-column">
          <div class="today-label" data-translate="day.today">Today</div>
          <button onclick="showMenu(DaysOfWeek.Saturday)" data-day="5">
            <span class="day-full" data-translate="day.saturday">Saturday</span>
            <span class="day-short" data-translate="day.saturday.short"
              >Sat</span
            >
          </button>
        </div>
        <div class="day-column">
          <div class="today-label" data-translate="day.today">Today</div>
          <button onclick="showMenu(DaysOfWeek.Sunday)" data-day="6">
            <span class="day-full" data-translate="day.sunday">Sunday</span>
            <span class="day-short" data-translate="day.sunday.short">Sun</span>
          </button>
        </div>
      </div>

      <!-- Meal Type Control Panel -->
      <div
        class="meal-control-panel"
        id="mealControlPanel"
        style="display: none"
      >
        <button
          class="meal-type-btn active"
          onclick="showMealType('lunch')"
          data-type="lunch"
        >
          <span data-translate="meal.lunch">Lunch</span>
        </button>
        <button
          class="meal-type-btn"
          onclick="showMealType('dinner')"
          data-type="dinner"
        >
          <span data-translate="meal.dinner">Dinner</span>
        </button>
        <button
          class="meal-type-btn"
          onclick="showMealType('alternative')"
          data-type="alternative"
        >
          <span data-translate="meal.alternative">Alternative</span>
        </button>
      </div>

      <!-- Error Message -->
      <div class="error-message" id="errorMessage" style="display: none">
        <h3 data-translate="error.title">‚ö†Ô∏è Unable to Load Menu</h3>
        <p data-translate="error.message">
          Failed to load meal data due to parsing issues. Please try refreshing
          the page or check back later.
        </p>
        <button
          class="error-refresh-btn"
          onclick="refreshPage()"
          data-translate="error.refresh"
        >
          üîÑ Refresh Page
        </button>
      </div>

      <!-- Menu Content -->
      <div class="menu-view" id="menuView">
        <div class="menu-category">
          <h2 data-translate="menu.lunch">Lunch Menu</h2>
          <div class="menu-grid" id="lunchMenu"></div>
        </div>

        <div class="menu-category">
          <h2 data-translate="menu.dinner">Dinner Menu</h2>
          <div class="menu-grid" id="dinnerMenu"></div>
        </div>

        <div class="menu-category">
          <h2 data-translate="menu.alternative">Alternative Menu</h2>
          <div class="menu-grid" id="alternativeMenu"></div>
        </div>
      </div>
    </div>
    <footer
      style="
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px 20px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        margin-top: 60px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
      "
    >
      <div style="text-align: center">
        <p style="margin: 0 0 8px 0">
          <span data-translate="footer.parsed"
            >The data was parsed with AI from the following page:</span
          >
        </p>
        <a
          class="linkToKafemud"
          target="_blank"
          href="#"
          onclick="this.href=window.URL; window.open(this.href, '_blank');"
          style="
            color: #ff9434;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
          "
          onmouseover="this.style.color='#F83F35'"
          onmouseout="this.style.color='#FF9434'"
        >
          <span data-translate="footer.source"
            >Bilkent University Cafeteria Page</span
          >
        </a>
      </div>
    </footer>

    <script>
      const daysList = document.getElementById("daysList");
      const menuView = document.getElementById("menuView");
      const errorMessage = document.getElementById("errorMessage");
      const modal = document.getElementById("modal");
      const modalContent = document.getElementById("modalContent");
      const modalContributeBtn = document.getElementById("contribute-btn");
      const modalImage = document.getElementById("modalImage");
      const modalNameTr = document.getElementById("modalNameTr");
      const modalImageEn = document.getElementById("modalNameEn");

      const DaysOfWeek = {
        Monday: 0,
        Tuesday: 1,
        Wednesday: 2,
        Thursday: 3,
        Friday: 4,
        Saturday: 5,
        Sunday: 6,
      };

      let currentDayIndex = -1;
      let currentMealType = "lunch";

      // Get current day of week (Monday = 0, Sunday = 6)
      function getCurrentDayOfWeek() {
        const today = new Date();
        const day = today.getDay();
        return day === 0 ? 6 : day - 1; // Convert Sunday (0) to 6, others shift by 1
      }

      // Get current meal type based on time
      function getCurrentMealType() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentTime = currentHour * 60 + currentMinute; // Convert to minutes for easier comparison

        // 00:00-14:00 (0 minutes to 840 minutes) -> Lunch
        // 14:01-23:59 (841 minutes to 1439 minutes) -> Dinner
        if (currentTime <= 840) {
          // 14:00 = 14 * 60 = 840 minutes
          return "lunch";
        } else {
          return "dinner";
        }
      }

      // Check if meal data is available
      function hasMealData(dayIndex) {
        if (
          typeof weeklyMealPlan === "undefined" ||
          !weeklyMealPlan[dayIndex]
        ) {
          return false;
        }
        const day = weeklyMealPlan[dayIndex];
        return (
          (day.lunch && day.lunch.length > 0) ||
          (day.dinner && day.dinner.length > 0) ||
          (day.alternative && day.alternative.length > 0)
        );
      }

      // Calculate and display current week
      function updateWeekIndicator() {
        const today = new Date();
        const weekNumber = getWeekNumber(today);
        const weekRange = getWeekDateRange(today);

        const weekText = document.getElementById("weekText");
        if (weekText) {
          // Get the translated week prefix
          const weekPrefix = window.languageSwitcher
            ? window.languageSwitcher.translate("week.prefix")
            : "Week";
          weekText.textContent = `${weekPrefix} ${weekNumber} - ( ${weekRange} )`;
        }
      }

      // Get week number of the year (ISO week) - same as submitUtils.ts
      function getWeekNumber(date) {
        const now = new Date(date);
        const target = new Date(now.valueOf());
        const dayNr = (now.getDay() + 6) % 7;
        target.setDate(target.getDate() - dayNr + 3);
        const firstThursday = target.valueOf();
        target.setMonth(0, 1);
        if (target.getDay() !== 4) {
          target.setMonth(0, 1 + ((4 - target.getDay() + 7) % 7));
        }
        return 1 + Math.ceil((firstThursday - target.valueOf()) / 604800000);
      }

      // Get the date range for the current week (Monday to Sunday)
      function getWeekDateRange(date) {
        const day = date.getDay();
        const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
        const monday = new Date(date.setDate(diff));
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);

        const formatDate = (d) => {
          const day = String(d.getDate()).padStart(2, "0");
          const month = String(d.getMonth() + 1).padStart(2, "0");
          const year = String(d.getFullYear()).slice(-2);
          return `${day}.${month}.${year}`;
        };

        return `${formatDate(monday)} - ${formatDate(sunday)}`;
      }

      // Initialize the app
      function initializeApp() {
        const todayIndex = getCurrentDayOfWeek();

        // Update week indicator
        updateWeekIndicator();

        if (hasMealData(todayIndex)) {
          // Auto-select meal based on current time
          currentMealType = getCurrentMealType();

          // Show current day if data is available
          showMenu(todayIndex);
        } else {
          // Show error message if no data
          showErrorMessage();
        }
      }

      // Show error message
      function showErrorMessage() {
        errorMessage.style.display = "block";
        menuView.style.display = "none";
        daysList.style.display = "flex";
        document.getElementById("mealControlPanel").style.display = "none";
        updateActiveDayButton(-1);
        updateErrorMessage();
      }

      // Update error message (can be called when language changes)
      function updateErrorMessage() {
        // Check if it's Monday morning (00:00 - 10:00 AM) and show specific message
        const now = new Date();
        const isMonday = now.getDay() === 1; // Monday = 1
        const isMorning = now.getHours() >= 0 && now.getHours() < 10;

        const errorTitle = document.querySelector("#errorMessage h3");
        const errorText = document.querySelector("#errorMessage p");

        if (errorTitle && errorText) {
          if (isMonday && isMorning) {
            errorTitle.textContent =
              "üìÖ " +
              (window.languageSwitcher
                ? window.languageSwitcher.translate("error.monday.title")
                : "Menu Unavailable");
            errorText.innerHTML = `
              ${
                window.languageSwitcher
                  ? window.languageSwitcher.translate("error.monday.message")
                  : "The meal menu is currently unavailable until early Monday morning. New weekly meal plans are updated every Monday."
              }
              <br><br>
              ${
                window.languageSwitcher
                  ? window.languageSwitcher.translate("error.monday.action")
                  : "Please check back later today or try refreshing the page."
              }
            `;
          } else {
            // Show regular error message
            errorTitle.textContent = window.languageSwitcher
              ? window.languageSwitcher.translate("error.title")
              : "‚ö†Ô∏è Unable to Load Menu";
            errorText.innerHTML = `
              ${
                window.languageSwitcher
                  ? window.languageSwitcher.translate("error.message")
                  : "Failed to load meal data due to parsing issues. Please try refreshing the page or check back later."
              }
            `;
          }
        }
      }

      // Update active day button
      function updateActiveDayButton(dayIndex) {
        const columns = daysList.querySelectorAll(".day-column");
        columns.forEach((column, index) => {
          if (index === dayIndex) {
            column.classList.add("active");
            column.querySelector("button").classList.add("active");
          } else {
            column.classList.remove("active");
            column.querySelector("button").classList.remove("active");
          }
        });
      }

      // Update today label to show on actual current day
      function updateTodayLabel() {
        const todayIndex = getCurrentDayOfWeek();
        const columns = daysList.querySelectorAll(".day-column");
        columns.forEach((column, index) => {
          if (index === todayIndex) {
            column.classList.add("today");
          } else {
            column.classList.remove("today");
          }
        });
      }

      // dayIndex : 0 = Monday, 1 = Tuesday, etc
      function showMenu(dayIndex) {
        // Check if data is available for this day
        if (!hasMealData(dayIndex)) {
          showErrorMessage();
          return;
        }

        // Hide error message
        errorMessage.style.display = "none";

        const lunchMenu = weeklyMealPlan[dayIndex].lunch;
        const dinnerMenu = weeklyMealPlan[dayIndex].dinner;
        const alternativeMenu = weeklyMealPlan[dayIndex].alternative;

        displayMenu("lunchMenu", lunchMenu);
        displayMenu("dinnerMenu", dinnerMenu);
        displayMenu("alternativeMenu", alternativeMenu);

        // Auto-select meal based on current time
        currentMealType = getCurrentMealType();

        // Show only the current meal type
        showMealType(currentMealType);

        // Show the menu view and control panel
        menuView.style.display = "block";
        menuView.style.opacity = "1";
        document.getElementById("mealControlPanel").style.display = "flex";

        // Update active button
        updateActiveDayButton(dayIndex);
        currentDayIndex = dayIndex;
      }

      // Show specific meal type
      function showMealType(mealType) {
        currentMealType = mealType;

        // Hide all menu categories
        const lunchCategory = document.querySelector(
          ".menu-category:nth-child(1)"
        );
        const dinnerCategory = document.querySelector(
          ".menu-category:nth-child(2)"
        );
        const alternativeCategory = document.querySelector(
          ".menu-category:nth-child(3)"
        );

        if (lunchCategory) lunchCategory.style.display = "none";
        if (dinnerCategory) dinnerCategory.style.display = "none";
        if (alternativeCategory) alternativeCategory.style.display = "none";

        // Show selected meal type
        if (mealType === "lunch" && lunchCategory) {
          lunchCategory.style.display = "block";
        } else if (mealType === "dinner" && dinnerCategory) {
          dinnerCategory.style.display = "block";
        } else if (mealType === "alternative" && alternativeCategory) {
          alternativeCategory.style.display = "block";
        }

        // Update active button in control panel
        updateActiveMealTypeButton(mealType);
      }

      // Update active meal type button
      function updateActiveMealTypeButton(mealType) {
        const buttons = document.querySelectorAll(".meal-type-btn");
        buttons.forEach((button) => {
          if (button.dataset.type === mealType) {
            button.classList.add("active");
          } else {
            button.classList.remove("active");
          }
        });
      }

      function displayMenu(menuId, menuItems) {
        const menuGrid = document.getElementById(menuId);
        menuGrid.innerHTML = "";

        menuItems.forEach((mealName, index) => {
          const mealItemDOM = document.createElement("div");
          mealItemDOM.className = "meal-item";

          // handle custom vegan UI for Vegan Food
          const isVegan = mealName.tr.includes("Vegan");
          const veganStyle = "background: green;";
          if (isVegan) {
            mealItemDOM.style.border = "1px solid green";
          }
          mealItemDOM.innerHTML = `
        <img src="assets/images/meals/${
          mealName.tr + ".jpg"
        }" onerror="this.onerror=null; this.src='assets/images/misc/missing-meal.jpg'" alt="Meal Image Here">
        <div class="meal-label" style="${isVegan ? veganStyle : ""}">${
            mealName.tr
          }</div>
      `;
          mealItemDOM.addEventListener("click", () => openModal(mealName));

          menuGrid.appendChild(mealItemDOM);
        });
      }

      // Remove goBack function since we're keeping day buttons always visible

      function goHome() {
        window.location.href = "index.html";
      }

      function refreshPage() {
        // Check if we're in mobile app context
        if (window.mobileApp && window.mobileApp.isMobileApp) {
          // Use the mobile app URL with proper parameters
          const mobileUrl = `https://www.bilmenu.com?mobile=true&lang=${window.mobileApp.language}&source=mobile-app`;
          window.location.href = mobileUrl;
        } else {
          // Regular refresh for web browser
          location.reload();
        }
      }

      function goToContributions() {
        window.location.href =
          "https://github.com/ndricimrr/bilmenu/blob/main/CONTRIBUTING_IMAGES.md";
      }

      function checkImageExists(url, callback) {
        const img = new Image();
        img.onload = function () {
          callback(true);
        };
        img.onerror = function () {
          callback(false);
        };
        img.src = url;
      }

      // Display the selected meal item in a larger modal
      function openModal(item) {
        const imageURL = `assets/images/meals/${item.tr}.jpg`;

        checkImageExists(imageURL, function (imageExists) {
          if (imageExists) {
            modalImage.src = `assets/images/meals/${item.tr}.jpg`;
          } else {
            // show fallback image and contribute button
            modalImage.src = `assets/images/misc/missing-meal.jpg`;
            modalContributeBtn.style.display = "inline";
          }

          const previousStyle = modalContributeBtn.style;

          // handle custom vegan UI for Vegan Food
          const isVegan = item.tr.includes("Vegan");
          const veganStyle = "color: green;";
          if (isVegan) {
            modalNameTr.style = veganStyle;
            modalImageEn.style = veganStyle;
            if (!imageExists) modalContributeBtn.style.background = "green";
          } else {
            // reset color so it doesnt get stuck to green
            modalNameTr.style = "color: black";
            modalImageEn.style = "color: black";
            if (!imageExists) {
              modalContributeBtn.style.display = "inline";
              modalContributeBtn.style.background = "#FF9434";
            }
          }

          // show meal names tr/en
          modalNameTr.innerHTML = item.tr;
          modalImageEn.innerHTML = item.en;
        });

        // Show modal
        modal.style.display = "block";
        modal.classList.add("show");
      }

      function closeModal() {
        modalContributeBtn.style.display = "none";
        modal.classList.remove("show");
        setTimeout(() => {
          modal.style.display = "none";
        }, 300);
      }

      // Close modal when clicking outside the content
      window.addEventListener("click", (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });

      // Close modal when pressing Escape key
      window.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && modal.style.display === "block") {
          closeModal();
        }
      });

      // Initialize the app when the page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Set up today label first
        updateTodayLabel();
        // Wait a bit for the meal data to load
        setTimeout(initializeApp, 100);
      });

      // Listen for language changes and update error message if needed
      document.addEventListener("languageChanged", function () {
        if (errorMessage.style.display === "block") {
          updateErrorMessage();
        }
      });
    </script>
  </body>
</html>
